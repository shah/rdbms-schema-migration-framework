# Relational Database Management System (RDBMS) Schema Migration Framework (RSMF)

The **Relational Database Management System (RDBMS) Schema Migration Framework** (**RSMF**) is an opionated approach to generating RDBMS
[schema migration](https://en.wikipedia.org/wiki/Schema_migration) files that can then be loaded as SQL files into any relational data storage engine.

RSMF uses [Jsonnet](https://jsonnet.org/) as the core configuration language and generates appropriate
SQL, schell scripts, and related artifacts.

Limitations:

* Only SQLite has been tested, but other database dialects will be possible using the framework.

Prerequisites:

* Linux server, tested only on Ubuntun 18.04
* user with sudo privileges and Docker permissions
* GNU Make, git, curl, wget, Jsonnet, jq, osQuery

Useful environment variables during installation:

Set **RSMF_HOME** to where the RSMF should be installed, defaults to /opt/rdbms-schema-migration-framework. If you
set this to something other than the default, you must make sure it's set whenever the Makefile is called, 
too, because all RSMF binaries and libs use the variable to indicate the installation location.

## How to Install the RSMF

Intial setup in default location:

    curl https://raw.githubusercontent.com/shah/rdbms-schema-migration-framework/master/bin/setup-RSMF.sh | bash

Intial setup in another location (e.g. /etc/RSMF):

    export RSMF_HOME=/etc/RSMF
    curl https://raw.githubusercontent.com/shah/rdbms-schema-migration-framework/master/bin/setup-RSMF.sh | bash

## How to Upgrade the RSMF

The directory where RSMF is installed is considered read-only. Any configuration files you add should be 
placed outside of the installation directory. The **JSONNET_PATH**, **RSMF_FACTS_FILES**, and other variables 
can be used to override configuration files so that your files instead of the defaults are used. 

Therefore, to upgrade you just:

    sudo rm -rf /opt/rdbms-schema-migration-framework
    curl https://raw.githubusercontent.com/shah/rdbms-schema-migration-framework/master/bin/setup-RSMF.sh | bash

## Checking Dependencies

RSMF has some important dependencies. After installation, you should run:

    cd /opt/rdbms-schema-migration-framework/lib
    make check-dependencies

## Conventions

RSMF manages RDBMS schemas using git, make, and [Jsonnet](https://jsonnet.org/). All developers looking
to extend RSMF need to know those tools very well. The framework manages schema migrations by an 
*opinionated* set of *conventions*:

Each schema migration is defined by files in a *schema migration definition home* ("SMDH") directory. 
The SMDH can be placed anywhere but follows these conventions:

* The *name* of the **SMDH** directory is assumed to be the schema migration name.
* Each **SMDH** directory contains, at a minium, a migration.rsmf-defn.jsonnet config file.
* Each **SMDH** directory contains a .gitignore file which is auto-generated by the Makefile
  and makes sure that no git tracking occurs for files generated by Jsonnet.
* The **SMDH** directory's Makefile feeds Jsonnet a migration.rsmf-defn.jsonnet and generates all necessary
  assets / artifacts.

## Scripts

* **RSMF_HOME/bin/rsmf-make** is a convenience script to run the Makefile in a **SMDH** if RSMF_HOME/lib/Makefile 
  is not symlink'd. This script is symlink'd as /usr/bin/rsmf-make by the installer.
* **RSMF_HOME/bin/rsmf-init** is a convenience script to download migration definition files from a common repo.
  This script is symlink'd as /usr/bin/rsmf-init by the installer.

## Environment Variables

These are the most useful environment variables to set before calling the Makefile, all of them have
sensible defaults:

* **JSONNET_PATH** is a colon-separated path which indicates where Jsonnet configs should be searched.
* **RSMF_HOME** is where the RSMF is installed (default is /opt/rdbms-schema-migration-framework).
* **RSMF_LOG_LEVEL** should be set to INFO to see verbose messages as RSMF does its job (default is NONE).
* **RSMF_FACTS_FILES** is where RSMF stores fact files - see "Facts Generator" section below for explanation.

## Migration Makefile

Each migration definition home ("CDH") directory may contain a Makefile which is, usually, symlink'd to
RSMF_HOME/lib/Makefile. This allows each migration to have it's own Makefile but conveniently
links to a master Makefile unless the migration has something special.

If the CDH does not contain a Makefile, then the **rsmf-make** convenience script may be used as a replacement.

The Makefile has a simple plugin model:

* If a file named **before_configure.make-plugin.sh** exists in the migration definition home directory,
  it is run right before the Makefile's configure target (*before* generating all artifacts).
* If a file named **after_configure.make-plugin.sh** exists in the migration definition home directory,
  it is run right after the Makefile's configure target (*after* generating all artifacts). Unlike the
  **before_configure.make-plugin.sh**, which must already exist before the code generator process starts, the
  **after_configure.make-plugin.sh** can be generated by Jsonnet's processing of migration.rsmf-defn.jsonnet.
* If a file named **migration.make.inc** exists in the migration definition home directory, it is
  included in the Makefile -- effectively allowing you to add targets. You can also redefine targets
  but you'll get a warning. The **migration.make.inc** may be generated as part of the code generation process.
* If a file named **after_start.make-plugin.sh** exists in the migration definition home directory, it
  is run immediately after the *make start* target concludes. This allows you to run some post-start
  functionality like checking the health of a migration or ensuring other dependencies are executed.
  The **after_start.make-plugin.sh** script can be generated by Jsonnet's processing of 
  migration.rsmf-defn.jsonnet.

The Makefile has these typical targets:

* **help** shows all the targets available in the Makefile -- use that instead of this document when possible
* **check-dependencies** evaluates the runtime environment to see if there's anything missing
* **configure** generates the migration's artifacts (driven by migration.rsmf-defn.jsonnet), then runs the
  **after_configure.make-plugin.sh** shell script (if it exists)
* **migrate** runs configure, then starts the migration and all dependencies
* **clean** cleans up generated files, networks, volumes, etc. (**DESTRUCTIVE**)

The Makefile can also have other containter-specific targets using the **migration.make.inc** feature.

In addition to the files created by Jsonnet processing of migration.rsmf-defn.jsonnet, the Makefile generates 
these housekeeping files:

* **.rsmf_migration.rsmf-defn.jsonnet_generated**, a text file that contains the list of files generated
* **.rsmf_delete_generated_files.sh**, which is executed by the **clean** target
* **.rsmf_facts** directory, which contains generated facts (see below)
* **.gitignore**, to make sure generated files are not tracked or committed (in case the migration is git-managed)

## Facts Generator

Before the migration.rsmf-defn.jsonnet file is interpreted, there are a series of "facts generator" scripts that
can be run to pre-populate configuration entries from the environment or an existing database engine. Facts can be 
retrieved from osquery, from the environment, or as arbitrary shell scripts snippets.

The Makefile uses this script by default, but it can be overridden:

    RSMF_FACTS_GENERATOR_SCRIPT ?= $(RSMF_HOME)/bin/generate-rsmf-facts.sh

Here's an example of the default $(RSMF_HOME)/etc/facts-generator.rsmf-conf.jsonnet configuration file:

    {
        osQueries: {
            singleRow : [
                { name: "system-localhost", query: "select * from system_info" }
                { name: "eth0-interface-localhost", query: "select * from interface_addresses where interface = 'eth0'" }
            ],
            multipleRows : [
                { name: "interfaces-localhost", query: "select * from interface_addresses" }
            ],
        },

        shellEvals: [
            { name: "docker-localhost", key: "dockerHostIPAddress", evalAsTextValue: "/sbin/ip -4 -o addr show dev eth0| awk '{split(\\$4,a,\\\"/\\\");print a[1]}'" },
            { name: "docker-localhost", key: "dockerBridgeNetworkGatewayIPAddress", evalAsTextValue: "docker network inspect --format='{{range .IPAM.Config}}{{.Gateway}}{{end}}' bridge" },
        ],
    }

You can pass one or more facts generator files, colon-separated, via the RSMF_FACTS_FILES environment variable.
The default value in the Makefile calls these source files, in this order:

    $(RSMF_HOME)/etc/common.rsmf-factsgen.jsonnet
    $(MIGRATION_DEFN_HOME)/migration.rsmf-factsgen.jsonnet

## Configuration Files

RSMF generates Dockerfile, docker-compose.yml, and a variety of other configuration files using Makefiles
and the [Jsonnet data templating language](https://jsonnet.org/). When Jsonnet runs, it uses the 
JSONNET_PATH Makefile variable defined in RSMF_HOME/lib/Makefile, but it can be overridden.

The default path is as follows, the earlier path in the list wins:

    $(HOME)/.rsmf/secrets
    $(HOME)/.rsmf/etc
    $(RSMF_HOME)/lib
    $(RSMF_HOME)/etc
